<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Dashboard + Profile</title>
    <link rel="shortcut icon" href="./img/svg/logo.svg" type="image/x-icon" />
    <link rel="stylesheet" href="./css/style.css" />

    <style>
        /* Profile card style */
        .profile-card {
            background: #fff;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 40px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 32px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 24px;
            margin-bottom: 24px;
        }

        .avatar-section {
            position: relative;
            width: 130px;
            height: 130px;
        }

        .avatar-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #4c6fff;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f1f5f9;
            position: relative;
        }

        .avatar-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #4c6fff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: #3b5bff;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 6px;
            color: #334155;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-action {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-delete-avatar {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-delete-avatar:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-update-profile {
            background: #4c6fff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-update-profile:hover {
            background: #3b5bff;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 111, 255, 0.4);
        }

        .alert {
            display: none;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="layer"></div>
    <a class="skip-link sr-only" href="#skip-target">Skip to content</a>

    <div class="page-flex">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-start">
                <div class="sidebar-head">
                    <a href="/" class="logo-wrapper" title="Home">
                        <span class="sr-only">Home</span>
                        <span class="icon logo" aria-hidden="true"></span>
                        <div class="logo-text">
                            <span class="logo-title">Admin</span>
                            <span class="logo-subtitle">Dashboard</span>
                        </div>
                    </a>
                    <button class="sidebar-toggle transparent-btn" title="Menu" type="button">
                        <span class="sr-only">Toggle menu</span>
                        <span class="icon menu-toggle" aria-hidden="true"></span>
                    </button>
                </div>
                <div class="sidebar-body">
                    <ul class="sidebar-body-menu">
                        <li>
                            <a class="active" href="/"><span class="icon home" aria-hidden="true"></span>Dashboard</a>
                        </li>
                        <li>
                            <a class="show-cat-btn" href="##">
                                <span class="icon document" aria-hidden="true"></span>My Articles
                                <span class="category__btn transparent-btn" title="Open list">
                                    <span class="sr-only">Open list</span>
                                    <span class="icon arrow-down" aria-hidden="true"></span>
                                </span>
                            </a>
                            <ul class="cat-sub-menu">
                                <li>
                                    <a href="all_articles.html">All Articles</a>
                                </li>
                                <li>
                                    <a href="create_article.html">Create Article</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a class="show-cat-btn" href="##">
                                <span class="icon folder" aria-hidden="true"></span>Categories
                                <span class="category__btn transparent-btn" title="Open list">
                                    <span class="sr-only">Open list</span>
                                    <span class="icon arrow-down" aria-hidden="true"></span>
                                </span>
                            </a>
                            <ul class="cat-sub-menu">
                                <li>
                                    <a href="categories.html">All categories</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="sidebar-footer">
                <a href="##" class="sidebar-user" id="sidebar-user">
        
                </a>
            </div>
        </aside>

        <!-- Main -->
        <div class="main-wrapper">
            <!-- Navbar -->
            <nav class="main-nav--bg">
                <div class="container main-nav">
                    <div class="main-nav-start">
                        <div class="search-wrapper">
                            <i data-feather="search" aria-hidden="true"></i>
                            <input type="text" placeholder="Enter keywords ..." required>
                        </div>
                    </div>
                    <div class="main-nav-end">
                        <button class="sidebar-toggle transparent-btn" title="Menu" type="button">
                            <span class="sr-only">Toggle menu</span>
                            <span class="icon menu-toggle--gray" aria-hidden="true"></span>
                        </button>
                        <div class="lang-switcher-wrapper">
                            <button class="lang-switcher transparent-btn" type="button">
                                EN
                                <i data-feather="chevron-down" aria-hidden="true"></i>
                            </button>
                            <ul class="lang-menu dropdown">
                                <li><a href="##">English</a></li>
                                <li><a href="##">French</a></li>
                                <li><a href="##">Uzbek</a></li>
                            </ul>
                        </div>
                        <button class="theme-switcher gray-circle-btn" type="button" title="Switch theme">
                            <span class="sr-only">Switch theme</span>
                            <i class="sun-icon" data-feather="sun" aria-hidden="true"></i>
                            <i class="moon-icon" data-feather="moon" aria-hidden="true"></i>
                        </button>
                        <div class="notification-wrapper">
                            <button class="gray-circle-btn dropdown-btn" title="To messages" type="button">
                                <span class="sr-only">To messages</span>
                                <span class="icon notification active" aria-hidden="true"></span>
                            </button>
                            <ul class="users-item-dropdown notification-dropdown dropdown">
                                <li>
                                    <a href="##">
                                        <div class="notification-dropdown-icon info">
                                            <i data-feather="check"></i>
                                        </div>
                                        <div class="notification-dropdown-text">
                                            <span class="notification-dropdown__title">System just updated</span>
                                            <span class="notification-dropdown__subtitle">The system has been
                                                successfully upgraded. Read more
                                                here.</span>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="##">
                                        <div class="notification-dropdown-icon danger">
                                            <i data-feather="info" aria-hidden="true"></i>
                                        </div>
                                        <div class="notification-dropdown-text">
                                            <span class="notification-dropdown__title">The cache is full!</span>
                                            <span class="notification-dropdown__subtitle">Unnecessary caches take up a
                                                lot of memory space and
                                                interfere ...</span>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="##">
                                        <div class="notification-dropdown-icon info">
                                            <i data-feather="check" aria-hidden="true"></i>
                                        </div>
                                        <div class="notification-dropdown-text">
                                            <span class="notification-dropdown__title">New Subscriber here!</span>
                                            <span class="notification-dropdown__subtitle">A new subscriber has
                                                subscribed.</span>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="link-to-page" href="##">Go to Notifications page</a>
                                </li>
                            </ul>
                        </div>
                        <div class="nav-user-wrapper">
                            <button href="##" class="nav-user-btn dropdown-btn" title="My profile" type="button">
                                <span class="sr-only">My profile</span>
                                <span class="nav-user-img" id="nav-user-img">
            
                                </span>
                            </button>
                            <ul class="users-item-dropdown nav-user-dropdown dropdown">
                                <li><a href="profile.html">
                                        <i data-feather="user" aria-hidden="true"></i>
                                        <span>Profile</span>
                                    </a></li>
                                <li><a class="danger" href="login.html">
                                        <i data-feather="log-out" aria-hidden="true"></i>
                                        <span>Log out</span>
                                    </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Dashboard -->
            <main class="main users chart-page" id="skip-target">
                <div class="container">
                    <div class="profile-card" id="profile-section">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="main-title" style="margin: 0;">My Profile</h3>
                            <button class="btn-delete-avatar" onclick="deleteAvatar()">
                                <span>üóëÔ∏è</span>
                                <span>Delete Avatar</span>
                            </button>
                        </div>
                        <div id="alertBox" class="alert"></div>

                        <div class="profile-header">
                            <div class="avatar-section">
                                <div class="avatar-wrapper">
                                    <img id="profileAvatar" src="./img/avatar/avatar-illustrated-01.png" alt="Avatar" />
                                    <button class="upload-btn" onclick="triggerFile()">üì§</button>
                                </div>
                                <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
                            </div>
                            <div class="profile-info">
                                <h3 id="profileName">Loading...</h3><br>
                                <p id="createdAt" style="color:#64748b;">Loading...</p>
                            </div>
                        </div>

                        <form id="profileForm">
                            <div class="form-group">
                                <label for="firstInput">First Name</label>
                                <input type="text" id="firstInput" name="firstName"
                                    placeholder="Enter your first name" />
                            </div>
                            <div class="form-group">
                                <label for="lastInput">Last Name</label>
                                <input type="text" id="lastInput" name="lastName" placeholder="Enter your last name" />
                            </div>
                            <div class="form-group">
                                <label for="emailInput">Email</label>
                                <input type="email" id="emailInput" name="email" placeholder="Enter your email" />
                            </div>
                        </form>

                        <div class="btn-action">
                            <button class="btn-update-profile" onclick="updateUserData()">
                                <span>‚úèÔ∏è</span>
                                <span>Update Profile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- ! Footer -->
            <footer class="footer">
                <div class="container footer--flex">
                    <div class="footer-start">
                        <p>2025 ¬© Admin Dashboard - <a href="#" target="_blank" rel="noopener noreferrer">Admin-dashboard.com</a>
                        </p>
                    </div>
                    <ul class="footer-end">
                        <li><a href="##">About</a></li>
                        <li><a href="##">Support</a></li>
                        <li><a href="##">Puchase</a></li>
                    </ul>
                </div>
            </footer>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Chart library -->
    <script src="./plugins/chart.min.js"></script>
    <!-- Icons library -->
    <script src="plugins/feather.min.js"></script>
    <!-- Custom scripts -->
    <script src="js/script.js"></script>
    <script src="js/sidebaruser.js"></script>
    <script>
        let token = localStorage.getItem('authToken');
        let nameEl = document.getElementById("profileName");
        let createdAt = document.getElementById("createdAt");
        let avatarEl = document.getElementById("profileAvatar");
        let alertBox = document.getElementById("alertBox");
        let loadingOverlay = document.getElementById("loadingOverlay");
        let avatarInput = document.getElementById("avatarInput");
        let firstInput = document.getElementById("firstInput");
        let lastInput = document.getElementById("lastInput");
        let emailInput = document.getElementById("emailInput");

        // Show alert with auto-hide
        function showAlert(message, type) {
            alertBox.className = `alert alert-${type} show`;
            alertBox.innerText = message;
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 5000);
        }

        // Fetch user data
        const fetchUserData = () => {
            fetch('http://blogs.csm.linkpc.net/api/v1/auth/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(res => res.json())
                .then(data => {
                    console.log(data.data);
                    if (data.data) {
                        firstInput.value = data.data.firstName || '';
                        lastInput.value = data.data.lastName || '';
                        emailInput.value = data.data.email || '';

                        const fullName = `${data.data.firstName || ''} ${data.data.lastName || ''}`.trim();
                        nameEl.textContent = fullName || 'User';

                        createdAt.textContent = data.data.registeredAt || 'N/A';

                        if (data.data.avatar) {
                            avatarEl.src = data.data.avatar;
                        }
                    } else {
                        showAlert('Invalid token or session expired.', 'error');
                        localStorage.removeItem('token');
                        setTimeout(() => {
                            location.href = 'login.html';
                        }, 2000);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showAlert('Failed to fetch user data.', 'error');
                });
        };

        // Trigger file input
        function triggerFile() {
            avatarInput.click();
        }

        // Handle avatar upload
        avatarInput.addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('Please select a valid image file.', 'error');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('Image size should be less than 5MB.', 'error');
                return;
            }

            // Preview image first
            const reader = new FileReader();
            reader.onload = function (e) {
                avatarEl.src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Upload to backend
            const formData = new FormData();
            formData.append("avatar", file);

            loadingOverlay.classList.add("show");

            fetch("http://blogs.csm.linkpc.net/api/v1/profile/avatar", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                body: formData
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(result => {
                    loadingOverlay.classList.remove("show");

                    if (result.ok) {
                        showAlert("Avatar uploaded successfully!", "success");
                        fetchUserData();
                    } else {
                        showAlert(result.data.message || "Failed to upload avatar!", "error");
                        // Revert to previous avatar on error
                        fetchUserData();
                    }
                })
                .catch(() => {
                    loadingOverlay.classList.remove("show");
                    showAlert("Error uploading avatar!", "error");
                    fetchUserData();
                });
        });

        // Delete avatar
        function deleteAvatar() {
            if (!confirm("Are you sure you want to delete your avatar?")) return;

            loadingOverlay.classList.add("show");

            fetch("http://blogs.csm.linkpc.net/api/v1/profile/avatar", {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(res => res.json().then(data => ({ ok: res.ok, data })))
                .then(result => {
                    loadingOverlay.classList.remove("show");

                    if (result.ok) {
                        avatarEl.src = "./img/avatar/avatar-illustrated-01.png";
                        showAlert("Avatar deleted successfully!", "success");
                    } else {
                        showAlert(result.data.message || "Failed to delete avatar!", "error");
                    }
                })
                .catch(() => {
                    loadingOverlay.classList.remove("show");
                    showAlert("Error deleting avatar!", "error");
                });
        }

        // Update user data
        const updateUserData = async () => {
            // Validate inputs
            if (!firstInput.value.trim() || !lastInput.value.trim() || !emailInput.value.trim()) {
                showAlert('All fields are required!', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailInput.value)) {
                showAlert('Please enter a valid email address!', 'error');
                return;
            }

            loadingOverlay.classList.add("show");

            try {
                const res = await fetch('http://blogs.csm.linkpc.net/api/v1/profile', {
                    method: "PUT",
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        firstName: firstInput.value.trim(),
                        lastName: lastInput.value.trim(),
                        email: emailInput.value.trim()
                    })
                });

                loadingOverlay.classList.remove("show");

                if (res.ok) {
                    showAlert('Profile updated successfully!', 'success');
                    fetchUserData();
                } else {
                    const errorData = await res.json();
                    const message = errorData.message || 'Unknown error occurred';
                    showAlert('Failed to update profile: ' + message, 'error');
                }
            } catch (error) {
                loadingOverlay.classList.remove("show");
                console.error(error);
                showAlert('Error updating profile!', 'error');
            }
        };

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            location.href = 'login.html';
        }

        // Initialize
        fetchUserData();
    </script>
</body>

</html>